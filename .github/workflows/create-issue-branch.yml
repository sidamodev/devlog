name: Create Issue Branch

on:
  issues:
    types: [opened]

jobs:
  create_issue_branch_job:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - name: Create branch from issue template
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const labels = (issue.labels || []).map((l) => l.name);
            const labelPrefixMap = { feat: "feat", refactor: "refactor", fix: "fix" };
            const matchedLabel = labels.find((name) => Object.keys(labelPrefixMap).includes(name));

            if (!matchedLabel) {
              core.info("No supported label found (feat/refactor/fix). Skip branch creation.");
              return;
            }

            const prefix = labelPrefixMap[matchedLabel];
            const issueNumber = issue.number;
            const body = issue.body || "";
            const slugMatch = body.match(/###\s*Branch Slug.*\n+([^\n\r]+)/i);

            if (!slugMatch) {
              core.setFailed("Branch Slug value is missing in issue body.");
              return;
            }

            const rawSlug = slugMatch[1].trim();
            const slug = rawSlug
              .toLowerCase()
              .replace(/[_\s]+/g, "-")
              .replace(/[^a-z0-9-]/g, "")
              .replace(/-+/g, "-")
              .replace(/^-|-$/g, "");

            if (!slug) {
              core.setFailed("Branch Slug is invalid after normalization.");
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const repoInfo = await github.rest.repos.get({ owner, repo });
            const defaultBranch = repoInfo.data.default_branch;
            const defaultBranchRef = await github.rest.git.getRef({
              owner,
              repo,
              ref: `heads/${defaultBranch}`,
            });

            const branchName = `${prefix}/#${issueNumber}-${slug}`;
            const ref = `refs/heads/${branchName}`;

            try {
              await github.rest.git.createRef({
                owner,
                repo,
                ref,
                sha: defaultBranchRef.data.object.sha,
              });
            } catch (error) {
              if (error.status === 422) {
                core.info(`Branch already exists: ${branchName}`);
              } else {
                throw error;
              }
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: `Created branch: \`${branchName}\``,
            });
